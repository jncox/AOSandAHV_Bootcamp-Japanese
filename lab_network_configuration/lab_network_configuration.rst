.. _lab_network_configuration:

------------------------------
ネットワーク構成
------------------------------

概要
++++++++

Prismを使用してクラスター内にネットワークを設定する方法を学びます。 以下の手順で作成するネットワークは、VMのそれぞれのNICに適切なネットワークを割り当てることにより、VMに接続を提供します。

AHVネットワーキングの背景
+++++++++++++++++++++++++

AHV は、すべての VM ネットワーキングに Open vSwitch (OVS) を活用しています。
OVSはLinuxカーネルに実装されたオープンソースのソフトウェアスイッチで、マルチサーバ仮想化環境で動作するように設計されています。
各 AHV サーバは OVS インスタンスを維持し、すべての OVS インスタンスを組み合わせて単一の論理スイッチを形成します。

各ノードは、通常、複数のVLANにトランク/タグ付けされた物理スイッチポートにアップリンクされ、仮想ネットワークとして利用されます。

VMネットワークはPrism（またはオプションでCLI/REST）を介して設定されるため、AHVでのネットワーク管理は非常にシンプルになります。以下のエクササイズでは、AHVでの仮想ネットワークの作成について説明します。

AHVでは、IPアドレス管理（IPAM）サービスを使用してVMにIPアドレスを自動的に提供するために、DHCPサーバを設定することもできます。つまり、ネットワーク用に別途DHCPサーバを設定する必要はありません。これにより、ネットワーク管理が容易になります。

AHVネットワークの詳細については `以下 <https://nutanixbible.com/#anchor-book-of-ahv-networking>`_ を参照ください。

仮想ネットワーク
................

- VMwareの「分散ポートグループ」に似ています
- 各仮想NICは1つの仮想ネットワークに属しています
- 各仮想ネットワークは、仮想NICのグループの共通の構成ポイントです
- 物理スイッチポートはトランクVLANに設定する必要があります

.. figure:: images/network_config_01.png
.. figure:: images/network_config_001.png

仮想マシンの仮想NIC
...................

- VMの各vNICは1つの仮想ネットワークに属します
- IPAM対応ネットワークの場合、vNICは生涯にわたる静的IP割り当てを取得します
- ユーザーはプールを構成してIPを自動的に割り当てるか、IPを手動で指定できます

.. figure:: images/network_config_02.png

IPアドレス管理 (IPAM)
............................

- 統合DHCPサーバー
- AHVはIPAMネットワーク上のゲストからのDHCP要求を傍受し、応答を注入します
- 仮想化管理者がIPアドレスの範囲を管理します
- 任意のDHCPオプションをサポートし、DNSおよびTFTP構成のUIをサポートします

.. figure:: images/network_config_03.png

ネットワーク構成
+++++++++++++++++

.. note::

   次の演習では、無効な VLAN を使用してネットワークを作成し、VM トラフィックが個々のホストの外部に送信されないようにします。
   この演習は、デモ/トレーニングの目的に限ります。　

ユーザー仮想マシン向けネットワークのセットアップ
.....................

Prism Elementに接続し、ユーザーVMインタフェース用のネットワークを作成します。VLANは0以外の任意のものを使用し、IPアドレス管理は有効にしないでください。

#. **Prism Element > VM** と進み、 **VMs** の **Network Config** をクリックします。

#. **VM Networks** を選択し、 **+ Create Network** をクリックします。

#. 次のフィールドに入力し、 **Save** をクリックします。

   - **Name** - *Initials*-Network
   - **VLAN ID** - **Primary** と **Secondary** ネットワークで使用していないIDかつ、4096以下のVLAN IDを指定します。
   - **Enable IP Address Management** は選択しないでください。

   最終的には以下の画像の様になります。

   .. figure:: images/network_config_04.png

   設定された仮想ネットワークは、クラスタ内のすべてのノードで利用できるようになります。AHVの仮想ネットワークは、ESXiの分散仮想スイッチのように動作するため、クラスタ内の個々のホストで同じ設定をする必要はありません。IPAM 管理ネットワークで VM を作成する場合、vNIC作成時に、IPをオプションで手動で指定できます。

IPAMを使ったユーザー仮想マシン向けネットワークのセットアップ
...............................

IPAMを有効にした、別のネットワークを作成します。

#. 次のフィールドに入力し、 **Save** をクリックします。

   - **Name** - *Initials*-Network_IPAM
   - **VLAN ID** - **Primary** と **Secondary** ネットワークで使用していないIDかつ、4096以下のVLAN IDを指定します。
   - **Enable IP Address Management** を選択してください。
   - **Network IP Address / Prefix Length** - 10.0.0.0/24
   - **Gateway** - 10.0.0.1
   - **Configure Domain Settings** を選択しないでください。
   - **Create Pool** - 10.0.0.100-10.0.0.150
   - **Override DHCP Server** を選択しないでください。

   .. figure:: images/network_config_03.png

.. note::

   １つのネットワークに対して複数のプール範囲を作成することが可能です。

これで、構成された仮想ネットワークがクラスタ内のすべてのノードで利用できるようになります。
このネットワーク上のvNICを持つVMは、指定された範囲のDHCPアドレスを受信します。
このIP割り当てはVMのが削除されるまで続くため、多くのワークロードでDHCP予約やスタティックIPに依存する必要はありません。

まとめ
+++++++++

- VM接続を確立するためにクラスタ内にネットワークを設定するのは非常に簡単です
- IPAMはネットワーク内でのセットアップが非常に簡単で、クラスタ内のIP管理を大幅に簡素化することができます
